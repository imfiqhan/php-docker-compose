version: '3'

networks:
  app:
    name: ${STACK_NAME}

services:
  site:
    image: nginx
    container_name: ${STACK_NAME}-nginx
    user: ${UID:-1000}:${GID:-1000}
    restart: unless-stopped
    ports:
      - ${SITE_PORT}:80
      - ${SITE_SECURE_PORT}:443
    volumes:
      - ./src:/var/www/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/templates:/etc/nginx/templates
      - ./nginx/ssl/cert.pem:/etc/nginx/cert.pem
      - ./nginx/ssl/key.pem:/etc/nginx/key.pem
    cpus: 0.6
    mem_limit: 256m
    deploy:
      resources:
        limits:
          cpus: '0.6'
          memory: 256M
    depends_on:
      - php
      - mysql
      - adminer
      # - postgres
    networks:
      - app

  mysql:
    image: mariadb:lts
    container_name: ${STACK_NAME}-mysql
    restart: unless-stopped
    tty: true
    ports:
      - ${MYSQL_PORT}:3306
    user: ${UID:-1000}:${GID:-1000}
    environment:
      MYSQL_DATABASE: ${STACK_NAME}
      MYSQL_USER: ${STACK_NAME}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/log:/var/log/mysql
    command: --log_error=/var/lib/mysql/mysql_error.log --general_log_file=/var/lib/mysql/mysql.log --general_log=1 --slow_query_log=1 --slow_query_log_file=/var/lib/mysql/mysql_slow.log --long_query_time=2 --log_queries_not_using_indexes=1 --max_allowed_packet=${DATABASE_MAX_ALLOWED_PACKET}
    healthcheck:
      test:
        [
          'CMD',
          '/usr/local/bin/healthcheck.sh',
          '--innodb_initialized'
        ]
      start_period: 5s
      timeout: 5s
      interval: 5s
      retries: 5
    cpus: 1.0
    mem_limit: 512m
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    networks:
      - app

  # TODO: fix for run using non-root user
  # postgres:
  #   image: postgres
  #   container_name: ${STACK_NAME}-postgres
  #   restart: unless-stopped
  #   tty: true
  #   ports:
  #     - ${POSTGRES_PORT}:5432
  #   user: ${UID:-1000}:${GID:-1000}
  #   environment:
  #     POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
  #     POSTGRES_USER: root
  #     POSTGRES_DB: ${STACK_NAME}
  #   volumes:
  #     - ./postgresql:/var/lib/postgresql
  #   cpus: 1.0
  #   mem_limit: 512m
  #   networks:
  #     - ${STACK_NAME}

  php:
    build:
      context: .
      dockerfile: php.dockerfile
      args:
        - UID=${UID:-1000}
        - GID=${GID:-1000}
        - PHP_VERSION=${PHP_VERSION}
    container_name: ${STACK_NAME}-php
    restart: unless-stopped
    volumes:
      - ./src:/var/www/html
      - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini
      - ./php/docker-php-ext-opcache.ini:/usr/local/etc/php/conf.d/docker-php-ext-opcache.ini
    cpus: 1.0
    mem_limit: 128m
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 128M
    networks:
      - app

  adminer:
    image: adminer
    container_name: ${STACK_NAME}-adminer
    restart: unless-stopped
    ports:
      - ${ADMINER_PORT}:8080
    user: ${UID:-1000}:${GID:-1000}
    cpus: 0.2
    mem_limit: 50m
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 50M
    networks:
      - app
  # mailpit:
  #   image: axllent/mailpit:latest
  #   container_name: ${STACK_NAME}-mailhog
  #   restart: unless-stopped
  #   ports:
  #     - ${MAILHOG_PORT}:1025
  #     - ${MAILHOG_UI_PORT}:8025
  #   cpus: 0.6
  #   mem_limit: 64m
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.6'
  #         memory: 64M
  #   networks:
  #     - ${STACK_NAME}
